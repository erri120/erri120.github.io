<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Breaking EA Desktop's pathetic Encryption | erri120's random Blog</title><meta name=keywords content="Reverse Engineering"><meta name=description content="EA made a sad attempt to prevent me from reading their files. I&rsquo;ll explain how I went about breaking their encryption."><meta name=author content="erri120"><link rel=canonical href=https://erri120.github.io/posts/2023-01-18/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><link rel=icon href=https://erri120.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://erri120.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://erri120.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://erri120.github.io/apple-touch-icon.png><link rel=mask-icon href=https://erri120.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta name=google-site-verification content="c-L5KbBKeVyZ9YNKiotqlpl7zsiDRiGcWJa4ZxVpzAo"><meta name=msvalidate.01 content="0E353603CBFC6B4F85D605C4E9F27290"><script data-goatcounter=https://erri120.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link rel=stylesheet href=/syntax.css><meta property="og:title" content="Breaking EA Desktop's pathetic Encryption"><meta property="og:description" content="EA made a sad attempt to prevent me from reading their files. I&rsquo;ll explain how I went about breaking their encryption."><meta property="og:type" content="article"><meta property="og:url" content="https://erri120.github.io/posts/2023-01-18/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-18T15:57:18+01:00"><meta property="og:site_name" content="erri120's random Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Breaking EA Desktop's pathetic Encryption"><meta name=twitter:description content="EA made a sad attempt to prevent me from reading their files. I&rsquo;ll explain how I went about breaking their encryption."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://erri120.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Breaking EA Desktop's pathetic Encryption","item":"https://erri120.github.io/posts/2023-01-18/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Breaking EA Desktop's pathetic Encryption","name":"Breaking EA Desktop\u0027s pathetic Encryption","description":"EA made a sad attempt to prevent me from reading their files. I\u0026rsquo;ll explain how I went about breaking their encryption.","keywords":["Reverse Engineering"],"articleBody":"Background Before I go in-depth on the encryption, I want to start by explaining the background of all of this:\nI’m the developer of GameFinder, a .NET library for finding games installed via various stores. The library supports Steam, GOG Galaxy, the Epic Games Store, Origin and now also EA Desktop. In case you haven’t seen the news, EA is deprecating Origin and replacing it with their new program: “EA Desktop” or “EA App”. The old way of finding games installed via Origin doesn’t work for EA Desktop. This blog post will detail my 4-day journey of figuring out how I can support EA Desktop, which ultimately led to me reverse engineering and breaking its pathetic encryption.\nStart of the journey All of this began when I wanted to add support for EA Desktop. Origin had previously used manifest files to store information about installed games. These manifest files were located in C:\\Program Data\\Origin\\LocalContent, however EA Desktop doesn’t create those files anymore.\nI started by looking around in C:\\Program Data and found a folder named EA Desktop:\nC:. │ machine.ini │ ├───530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e │ CATS │ IQ │ IS │ IS.json │ ├───6d13902b1570caf2c578d1f15fb1d5d9a2e62426246bc5eebea5707931ecdc21 │ CS │ IQ │ ├───InstallData │ └───Apex │ └───base-Origin.SFT.50.0000848 │ └───Logs EABackgroundService.log We have some very ominous looking folder names, some installation data and a couple log files. However, notice that IS.json file? This is what started this rabbit hole, because it looks like this (you can view the full file here):\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 { \"installInfos\": [ { \"baseInstallPath\": \"\", \"baseSlug\": \"plants-vs-zombies-garden-warfare-2\", \"softwareId\": \"Origin.SFT.50.0000345\" }, { \"baseInstallPath\": \"E:\\\\SteamLibrary\\\\steamapps\\\\common\\\\Titanfall2\\\\\", \"baseSlug\": \"titanfall-2\", \"softwareId\": \"Origin.SFT.50.0000532\" }, { \"baseInstallPath\": \"M:\\\\Games\\\\new EA App is shit\\\\Apex\\\\\", \"baseSlug\": \"apex-legends\", \"softwareId\": \"Origin.SFT.50.0000848\" }, { \"baseInstallPath\": \"M:\\\\SteamLibrary\\\\steamapps\\\\common\\\\Need for Speed Heat\\\\\", \"baseSlug\": \"need-for-speed-heat\", \"softwareId\": \"Origin.SFT.50.0001079\" }, { \"baseInstallPath\": \"\", \"baseSlug\": \"need-for-speed-hot-pursuit-remastered\", \"softwareId\": \"Origin.SFT.50.0001232\" } ], \"schema\": { \"version\": 21 } } When I found this file, I thought I was done already. This file contains everything I need for the library: the installation path, some identifier and the name of the game. I quickly wrote my implementation and send a debug build of my library to some testers that came back with this error message:\nUnable to find IS.json inside data folder C:\\ProgramData\\EA Desktop Turns out I’m the only one that has this IS.json file. Looking at the file dates, I noticed that it was created in early December 2022 and never touched again. I’m guessing some earlier version of EA Desktop created this file, but not anymore. Instead, it creates a file called IS in the same folder.\nAnalysis with CyberChef Note: I will be using CyberChef throughout this blog post, if you want to follow along, you can download my encrypted file from GitHub and load it into CyberChef.\nAt this point I had no idea what I’m dealing with, so I grabbed the IS file and just looked at the Hexdump:\nHexdump of the first 240 bytes\nThe file starts out with some kind of 256-bit hash, written as plaintext and the rest is just an incoherent collection of bytes. The Shannon Entropy is a good measure to identify if the input is structured or unstructured, and applying it on everything after the hash results in a value of 7.965:\nVisualization of the Shannon Scale on the input\nIt’s safe to assume the contents are encrypted. Now we only have to figure out what algorithm and key were used.\nTrying out everything At this point I couldn’t do much without doing some reverse engineering. But before I can open up my favorite tool, I had to figure out what process even creates this file. Thankfully the Sysinternals Tools are amazing as always and provide the Process Monitor tool for monitoring file activity in real-time.\nI noticed that the changed date of the encrypted file changes when I start or stop a download. Realizing this, I prepared a big download of Apex Legends, limited the download speed to 512kb/s and started monitoring with Process Monitor using this filter:\nAdding a path filter to Process Monitor\nWith this filter activated, Process Monitor will only display entries where the path points to the encrypted file. After starting the monitoring and resuming and pausing the Apex Legends download a couple of times, I got these results:\nProcess Monitor results\nThe process EABackgroundService.exe seems to be the only one that accesses those files. What’s even more impressive with Process Monitor, is the fact that you can double-click any of these entries and view the stack:\nStack of the first WriteFile entry\nI now had everything I needed: the encrypted file, the decrypted file, the process that creates the file and multiple locations I can investigate.\nDebugging and Reverse Engineering Identifying the Algorithm Note: I’m writing this blog post on 2023-01-18, the file version of EABackgroundService.exe is 12.85.0.5342 and its SHA256 hash is ba93d7a3a406128df5adc8f32322a897196eea83a6976b409dbd0e5401a612c8.\nWith the stack information from Process Monitor, I could start diving into the assembly code of the process. I used x64dbg to attach and debug the process and Ghidra to reverse engineering compiled code.\nI started out by going up the call stack and looking at each function in Ghidra. The first couple functions were just wrapper functions around CreateFileW, WriteFile and other file system related stuff. However, the fourth function at EABackgroundService+0x271644 was a hit. Not only is this function massive, it references some interesting strings:\nSaving [{}] into file: \\n[{}] eax::services::localStorage::encryptDataToFile I don’t think you can get more obvious than this. Turns out that excessive logging with inlined strings are really helpful.\nI found an interesting function, now I only had to figure out what it does and where the encryption is being done. For this I don’t have any neat tricks up my sleeve, I just put a breakpoint at the start of the function in x64dbg and went through it step by step while also looking at the same code in Ghidra. I was mostly interested in the function parameters being passed, so I kept my eye on the RCX, RDX, R8 and R9 registers which are being used to pass parameters for the x64 calling convention.\nIt didn’t take me long to find a very interesting call at 0x270f26 with these parameters:\nRCX: address of some region in memory RDX: address of the plaintext R8: address to 01B42F0E7E3B32E7C4251BC38FA2AE2EDB8DC26498E5B73E2A92AC9E8FFCB4F4 R9: address to 84EFC4B836119C20419398C3F3F2BCEF6FC52F9D86C6E4E8756AEC5A8279E492 This was very suspicious. After opening the function in Ghidra, I was very overjoyed to find this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 // before cleanup uVar2 = EVP_aes_256_cbc(); iVar1 = FUN_345be0(local_c8, param_2, param_3, param_4, uVar2, local_e8); if (iVar1 \u003c 1) { FUN_54e50(\u0026local_60, \"AES256 CBC encryption failed\", 0x1c); } // after cleanup cipherType = EVP_aes_256_cbc(); ok = Encrypt(local_c8, plaintext, key, iv, cipherType, encryptedOut); if (!ok) { Log(\u0026local_60, \"AES256 CBC encryption failed\", 0x1c); } Turns out that EA Desktop is using OpenSSL’s EVP functions to encrypt their files. In this case the file we need is encrypted using AES with a key length of 256 bits using the Cipher Block Chaining (CBC) mode.\nUsing x64dbg, I just dumped the Key and IV from memory and used CyberChef to successfully decrypt the file:\nSuccessful decryption in CyberChef\nRecreating the IV At this point I was very happy. I managed to identify the algorithm being used and was able to decrypt the file using the Key and IV from memory. The next step was figuring out how I can recreate them. You have to remember that my goal is to implement a method in my library, that can decrypt the file on its own, without requiring the consumer of the library to do anything special.\nI started by following the parameters being passed to the encryption function. These values have to come from somewhere and I intend to find out where. Once again, I’m using x64dbg to step through the function and look closely at the registers. Now that I know what the Key and IV look like, I can identify the functions that create them or at least reference them.\nAnd just as luck would have it, I found a function before the encryption function that accepts some curious parameters and outputs the Key and IV:\nRCX: address of some region in memory RDX: address of the string allUsersGenericId R8: address of the string IS Once again I investigated and after a bit of cleanup, the function essentially does this:\n1 2 3 4 CreateCryptographicHash(cryptographicHash, 0x100); AddDataToHash(cryptographicHash, param_2); AddDataToHash(cryptographicHash, param_3); ok = FinalizeHash(cryptographicHash, \u0026finalHashOut); These are wrapper functions for QCryptographicHash from Qt 5. CreateCryptographicHash is a wrapper for the constructor QCryptographicHash(QCryptographicHash::Algorithm method) where they always pass SHA3 256 as the algorithm and AddDataToHash is a wrapper for addData(const char *data, int length).\nIf you’re like me, and you see this, then you quickly head over to CyberChef, input allUsersGenericIdIS and create the SHA3 256 hash to get THE IV as output: 84efc4b836119c20419398c3f3f2bcef6fc52f9d86c6e4e8756aec5a8279e492.\nTHE IV NEVER CHANGES: It’s always SHA3_256(\"allUsersGenericId\" + \"IS\"), a fucking constant.\nAs a quick side note: remember 530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e? This is the folder name of the file IS. This is also a SHA3 256 hash (CyberChef):\nSHA3_256(\"allUsersGenericId\") = 530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e I have no idea where this allUsersGenericId comes from, but some genius at EA thought it would be a good idea to include this in almost every hash.\nRecreating the Key Anyways, we have the IV. Now the remaining part is figuring out how to recreate the Key, which turned out to be more involved than the IV.\nThe function that creates IV did some more stuff afterwards. They reset the SHA3 256 hash instance and added some very interesting data to it: allUsersGenericIdISa2a0ad25aa3556c035b34ea63863794e54ad5b53 (CyberChef)\nSHA3_256(\"allUsersGenericIdISa2a0ad25aa3556c035b34ea63863794e54ad5b53\") = 01b42f0e7e3b32e7c4251bc38fa2ae2edb8dc26498e5b73e2a92ac9e8ffcb4f4 This is the key we previously dumped from memory. Let’s break this down: \"allUsersGenericId\" + \"IS\" + \"a2a0ad25aa3556c035b34ea63863794e54ad5b53\". The first two parts are already known to us, they are the components of the IV. The last part a2a0ad25aa3556c035b34ea63863794e54ad5b53 is more interesting. This looks like another hash, but it only has a length of 160 bits. Once again we can use CyberChef to analyze this hash:\nHash length: 40 Byte length: 20 Bit length: 160 Based on the length, this hash could have been generated by one of the following hashing functions: SHA-1 SHA-0 FSB-160 HAS-160 HAVAL-160 RIPEMD-160 Tiger-160 Based on the previous results, I’m assuming this is a SHA1 hash, since that’s the only one that OpenSSL supports. With this information in hand, I decided to try going the opposite way and start with the import of EVP_sha1 and look at what references this. Turns out there is only one function that uses this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ulonglong HashSomething(undefined8* param_1, undefined8 param_2, int param_3, undefined8* param_4, int param_5) { switch (param_5 - 2) { //... case 3: algorithm = EVP_sha1(); break; //... } ctx = EVP_MD_CTX_new(); ok = EVP_DigsteInit_ex(ctx, algorithm, nullptr); EVP_DigestUpdate(ctx, param_2, param_3); EVP_DigestFinal_ex(ctx, *param_4, \u0026param_5); EVP_MD_CTX_free(ctx); } I aptly named this function HashSomething as it appears to be some sort of general purpose hashing function that takes some input, the output buffer and probably an enum to control which hashing algorithm should be used. This looked very promising, so I went back to x64dbg, put a breakpoint at the start of the function and inspected the input, only to find this:\n1 ASRock; ;American Megatrends Inc.;To Be Filled By O.E.M.;7CB7433E;PCI\\VEN_10DE\u0026DEV_2486\u0026SUBSYS_147A10DE\u0026REV_A1\\4\u00262283F625\u00260\u00260019;AuthenticAMD;178BFBFF00A20F10;AMD Ryzen 7 5800X 8-Core Processor ; Using CyberChef to verify my assumption, I was very happy to find out that this is the missing component:\nSHA1(hardwareInfo) = a2a0ad25aa3556c035b34ea63863794e54ad5b53 They hash the hardware info using SHA1, then combine that hash with the constants allGenericId and IS to create the Key.\nHardware Information In order to replicate the hardware info hash, I needed to figure out which components and which properties went into it and where they are getting the information from. On Windows, the best way to do this, is to use the WMI. I’ve never used the WMI, so I just checked out an example to find the library functions I need to look out for. These include CoInitialize, CoCreateInstance and CoSetProxyBlanket, just to name a few. With that newly found information, I went back into Ghidra and went up the call stack of the general purpose hashing function to find something that looks good.\nI ended up in a function that was being called by the function that creates the IV and Key. However, I noticed that there was a big fat static initialization being done. Turns out that they collect your hardware information when the process starts and then never again. Using x64dbg to restart the process and I stepped through the static initialization to figure out what was going on.\nAfter a rather tedious process of continuously looking at register values until something made sense, I managed to extract every class and property name used to create the hardware info:\nWin32_BaseBoard Manufacturer = ASRock Win32_BaseBoard SerialNumber = (string with lots of whitespace) Win32_BIOS Manufacturer = American Megatrends Inc. Win32_BIOS SerialNumber = To Be Filled By O.E.M. Win32_VideoController PNPDeviceId = PCI\\VEN_10DE\u0026DEV_2486\u0026SUBSYS_147A10DE\u0026REV_A1\\4\u00262283F625\u00260\u00260019 Win32_Processor Manufacturer = AuthenticAMD Win32_Processor ProcessorId = 178BFBFF00A20F10 Win32_Processor Name = AMD Ryzen 7 5800X 8-Core Processor (also had a lot of whitespace at the end) You can try this out yourself by using the wmic tool:\n1 wmic PATH Win32_BaseBoard get Manufacturer But we’re not done yet. There is one value missing: 7CB7433E. This is the hex value of the serial number of the volume associated with the root directory of your C:\\ drive. It is returned by GetVolumeInformationW. Note that this a different serial number from the one obtained by Win32_PhysicalMedia SerialNumber:\nThis function returns the volume serial number that the operating system assigns when a hard disk is formatted. To programmatically obtain the hard disk’s serial number that the manufacturer assigns, use the Windows Management Instrumentation (WMI) Win32_PhysicalMedia property SerialNumber.\nConclusion graph TD allUsersGenericId \u0026 IS --\u003e allUsersGenericIdIS[allUsersGenericId + IS] hardwareInfo[Hardware Information] --\u003e |SHA1| hardwareInfoHash[Hardware Info Hash] allUsersGenericIdIS \u0026 hardwareInfoHash --\u003e combine[allUsersGenericId + IS + Hardware Info Hash] --\u003e |SHA3 256| KEY allUsersGenericIdIS --\u003e |SHA3 256| IV This flowchart shows the complete process of generating the Key and IV. With those values, you can easily decrypt the file using AES 256 CBC.\nLet’s go back to the point of all of this: finding out which games are installed. I did all of this just to decrypt a file that contains some installation paths to EA games. I don’t understand why this file is encrypted in the first place. It doesn’t make any sense. You encrypt a file because it contains sensitive information and/or you want to keep it from prying eyes. Now the question is “who is not supposed to read this file”? The fact that they created the plaintext version of this file at some point but later changed it on purpose means they don’t want anyone to read it.\nAnd this isn’t even all, if you look at the flowchart, you will realize that if the user changes a single hardware component of their PC, the Key will be different, and you won’t be able to decrypt the file anymore. The team at EA that implemented this and the person that made the decision to encrypt the file in the first place, have no idea what they are doing. This is a pathetic attempt to prevent users from reading this file.\nI have demonstrated how easy it is to “break” the encryption using tools like CyberChef, x64dbg and Ghidra. The “encryption” used by EA Desktop is straight up pathetic and useless. In the off chance that anyone from the team that works on the program is reading this: just write the plaintext file, there is no point in encrypting it.\nFor me personally, this has been a very fun adventure. I managed to make good progress every day and got more experience using the tools listed above and assembly in general. I can also now finally have support for EA Desktop in my GameFinder library, so users can stop pinging me about it.\n","wordCount":"2700","inLanguage":"en","datePublished":"2023-01-18T00:00:00Z","dateModified":"2023-01-18T15:57:18+01:00","author":{"@type":"Person","name":"erri120"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://erri120.github.io/posts/2023-01-18/"},"publisher":{"@type":"Organization","name":"erri120's random Blog","logo":{"@type":"ImageObject","url":"https://erri120.github.io/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://erri120.github.io accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://erri120.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://erri120.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://erri120.github.io/archives/ title=Archive><span>Archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://erri120.github.io>Home</a>&nbsp;»&nbsp;<a href=https://erri120.github.io/posts/>Posts</a></div><h1 class=post-title>Breaking EA Desktop's pathetic Encryption</h1><div class=post-meta><span title='2023-01-18 00:00:00 +0000 UTC'>2023-01-18</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;2700 words&nbsp;·&nbsp;erri120&nbsp;|&nbsp;<a href=https://github.com/erri120/erri120.github.io/edit/master/content/posts/2023-01-18.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#start-of-the-journey>Start of the journey</a></li><li><a href=#analysis-with-cyberchef>Analysis with CyberChef</a></li><li><a href=#trying-out-everything>Trying out everything</a></li><li><a href=#debugging-and-reverse-engineering>Debugging and Reverse Engineering</a><ul><li><a href=#identifying-the-algorithm>Identifying the Algorithm</a></li><li><a href=#recreating-the-iv>Recreating the IV</a></li><li><a href=#recreating-the-key>Recreating the Key</a></li><li><a href=#hardware-information>Hardware Information</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></details></div><div class=post-content><h2 id=background>Background<a hidden class=anchor aria-hidden=true href=#background>#</a></h2><p>Before I go in-depth on the encryption, I want to start by explaining the background of all of this:</p><p>I&rsquo;m the developer of <a href=https://github.com/erri120/GameFinder>GameFinder</a>, a .NET library for finding games installed via various stores. The library supports Steam, GOG Galaxy, the Epic Games Store, Origin and now also EA Desktop. In case you haven&rsquo;t seen the news, <a href=https://www.ea.com/en-gb/news/ea-app>EA is deprecating Origin</a> and replacing it with their new program: &ldquo;EA Desktop&rdquo; or &ldquo;EA App&rdquo;. The <a href=https://github.com/erri120/GameFinder/wiki/Origin>old way</a> of finding games installed via Origin doesn&rsquo;t work for EA Desktop. This blog post will detail my 4-day journey of figuring out how I can support EA Desktop, which ultimately led to me reverse engineering and breaking its pathetic encryption.</p><h2 id=start-of-the-journey>Start of the journey<a hidden class=anchor aria-hidden=true href=#start-of-the-journey>#</a></h2><p>All of this began when I wanted to add support for EA Desktop. <a href=https://github.com/erri120/GameFinder/wiki/Origin>Origin</a> had previously used manifest files to store information about installed games. These manifest files were located in <code>C:\Program Data\Origin\LocalContent</code>, however EA Desktop doesn&rsquo;t create those files anymore.</p><p>I started by looking around in <code>C:\Program Data</code> and found a folder named <code>EA Desktop</code>:</p><pre tabindex=0><code>C:.
│   machine.ini
│
├───530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e
│       CATS
│       IQ
│       IS
│       IS.json
│
├───6d13902b1570caf2c578d1f15fb1d5d9a2e62426246bc5eebea5707931ecdc21
│       CS
│       IQ
│
├───InstallData
│   └───Apex
│       └───base-Origin.SFT.50.0000848
│
└───Logs
        EABackgroundService.log
</code></pre><p>We have some very ominous looking folder names, some installation data and a couple log files. However, notice that <code>IS.json</code> file? This is what started this rabbit hole, because it looks like this (you can view the full file <a href=https://github.com/erri120/GameFinder/wiki/EA-Desktop#decrypted-file>here</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;installInfos&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseInstallPath&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseSlug&#34;</span><span class=p>:</span> <span class=s2>&#34;plants-vs-zombies-garden-warfare-2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;softwareId&#34;</span><span class=p>:</span> <span class=s2>&#34;Origin.SFT.50.0000345&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseInstallPath&#34;</span><span class=p>:</span> <span class=s2>&#34;E:\\SteamLibrary\\steamapps\\common\\Titanfall2\\&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseSlug&#34;</span><span class=p>:</span> <span class=s2>&#34;titanfall-2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;softwareId&#34;</span><span class=p>:</span> <span class=s2>&#34;Origin.SFT.50.0000532&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseInstallPath&#34;</span><span class=p>:</span> <span class=s2>&#34;M:\\Games\\new EA App is shit\\Apex\\&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseSlug&#34;</span><span class=p>:</span> <span class=s2>&#34;apex-legends&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;softwareId&#34;</span><span class=p>:</span> <span class=s2>&#34;Origin.SFT.50.0000848&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseInstallPath&#34;</span><span class=p>:</span> <span class=s2>&#34;M:\\SteamLibrary\\steamapps\\common\\Need for Speed Heat\\&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseSlug&#34;</span><span class=p>:</span> <span class=s2>&#34;need-for-speed-heat&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;softwareId&#34;</span><span class=p>:</span> <span class=s2>&#34;Origin.SFT.50.0001079&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseInstallPath&#34;</span><span class=p>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;baseSlug&#34;</span><span class=p>:</span> <span class=s2>&#34;need-for-speed-hot-pursuit-remastered&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;softwareId&#34;</span><span class=p>:</span> <span class=s2>&#34;Origin.SFT.50.0001232&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;schema&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nt>&#34;version&#34;</span><span class=p>:</span> <span class=mi>21</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>When I found this file, I thought I was done already. This file contains everything I need for the library: the installation path, some identifier and the name of the game. I quickly wrote my implementation and send a debug build of my library to some testers that came back with this error message:</p><pre tabindex=0><code>Unable to find IS.json inside data folder C:\ProgramData\EA Desktop
</code></pre><p>Turns out I&rsquo;m the only one that has this <code>IS.json</code> file. Looking at the file dates, I noticed that it was created in early December 2022 and never touched again. I&rsquo;m guessing some earlier version of EA Desktop created this file, but not anymore. Instead, it creates a file called <code>IS</code> in the same folder.</p><h2 id=analysis-with-cyberchef>Analysis with CyberChef<a hidden class=anchor aria-hidden=true href=#analysis-with-cyberchef>#</a></h2><p><strong>Note:</strong> I will be using <a href=https://gchq.github.io/CyberChef/>CyberChef</a> throughout this blog post, if you want to follow along, you can download my encrypted file from <a href=https://github.com/erri120/GameFinder/blob/6199b82c488760879c570efdd1b2ed7cde28de16/tests/GameFinder.StoreHandlers.EADesktop.Tests/files/IS_erri120.encrypted>GitHub</a> and load it into CyberChef.</p><p>At this point I had no idea what I&rsquo;m dealing with, so I grabbed the <code>IS</code> file and just looked at the <a href="https://gchq.github.io/CyberChef/#recipe=To_Hexdump(16,true,false,false)">Hexdump</a>:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/EA_Encryption_Hexdump.png#center alt="Hexdump of the first 240 bytes"><figcaption><p>Hexdump of the first 240 bytes</p></figcaption></figure><p>The file starts out with some kind of 256-bit hash, written as plaintext and the rest is just an incoherent collection of bytes. The <a href="https://gchq.github.io/CyberChef/#recipe=Drop_bytes(0,64,false)Entropy('Shannon%20scale')">Shannon Entropy</a> is a good measure to identify if the input is structured or unstructured, and applying it on everything after the hash results in a value of <code>7.965</code>:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/EA_Encryption_Shannon_Entropy.png#center alt="Visualization of the Shannon Scale on the input"><figcaption><p>Visualization of the Shannon Scale on the input</p></figcaption></figure><p>It&rsquo;s safe to assume the contents are encrypted. Now we only have to figure out what algorithm and key were used.</p><h2 id=trying-out-everything>Trying out everything<a hidden class=anchor aria-hidden=true href=#trying-out-everything>#</a></h2><p>At this point I couldn&rsquo;t do much without doing some reverse engineering. But before I can open up my favorite tool, I had to figure out what process even creates this file. Thankfully the <a href=https://learn.microsoft.com/en-us/sysinternals/>Sysinternals Tools</a> are amazing as always and provide the <a href=https://learn.microsoft.com/en-us/sysinternals/downloads/procmon>Process Monitor</a> tool for monitoring file activity in real-time.</p><p>I noticed that the changed date of the encrypted file changes when I start or stop a download. Realizing this, I prepared a big download of Apex Legends, limited the download speed to 512kb/s and started monitoring with Process Monitor using this filter:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/ProcessMonitor_Filter.png#center alt="Screenshot of Process Monitor that shows a path filter"><figcaption><p>Adding a path filter to Process Monitor</p></figcaption></figure><p>With this filter activated, Process Monitor will only display entries where the path points to the encrypted file. After starting the monitoring and resuming and pausing the Apex Legends download a couple of times, I got these results:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/ProcessMonitor_Results.png#center alt="Screenshot of Process Monitor that shows multiply entries that reference the encrypted file"><figcaption><p>Process Monitor results</p></figcaption></figure><p>The process <code>EABackgroundService.exe</code> seems to be the only one that accesses those files. What&rsquo;s even more impressive with Process Monitor, is the fact that you can double-click any of these entries and view the stack:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/ProcessMonitor_WriteFile_Stack.png#center alt="Screenshot of Process Monitor that shows the stack of the first WriteFile entry"><figcaption><p>Stack of the first WriteFile entry</p></figcaption></figure><p>I now had everything I needed: the encrypted file, the decrypted file, the process that creates the file and multiple locations I can investigate.</p><h2 id=debugging-and-reverse-engineering>Debugging and Reverse Engineering<a hidden class=anchor aria-hidden=true href=#debugging-and-reverse-engineering>#</a></h2><h3 id=identifying-the-algorithm>Identifying the Algorithm<a hidden class=anchor aria-hidden=true href=#identifying-the-algorithm>#</a></h3><p><strong>Note:</strong> I&rsquo;m writing this blog post on 2023-01-18, the file version of <code>EABackgroundService.exe</code> is <code>12.85.0.5342</code> and its SHA256 hash is <code>ba93d7a3a406128df5adc8f32322a897196eea83a6976b409dbd0e5401a612c8</code>.</p><p>With the stack information from Process Monitor, I could start diving into the assembly code of the process. I used <a href=https://x64dbg.com/>x64dbg</a> to attach and debug the process and <a href=https://github.com/NationalSecurityAgency/ghidra>Ghidra</a> to reverse engineering compiled code.</p><p>I started out by going up the call stack and looking at each function in Ghidra. The first couple functions were just wrapper functions around <a href=https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilew><code>CreateFileW</code></a>, <a href=https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-writefile><code>WriteFile</code></a> and other file system related stuff. However, the fourth function at <code>EABackgroundService+0x271644</code> was a hit. Not only is this function massive, it references some interesting strings:</p><ul><li><code>Saving [{}] into file: \n[{}]</code></li><li><code>eax::services::localStorage::encryptDataToFile</code></li></ul><p>I don&rsquo;t think you can get more obvious than this. Turns out that excessive logging with inlined strings are really helpful.</p><p>I found an interesting function, now I only had to figure out what it does and where the encryption is being done. For this I don&rsquo;t have any neat tricks up my sleeve, I just put a breakpoint at the start of the function in x64dbg and went through it step by step while also looking at the same code in Ghidra. I was mostly interested in the function parameters being passed, so I kept my eye on the <code>RCX</code>, <code>RDX</code>, <code>R8</code> and <code>R9</code> registers which are being used to pass parameters for the <a href="https://learn.microsoft.com/en-us/cpp/build/x64-calling-convention?view=msvc-170#parameter-passing">x64 calling convention</a>.</p><p>It didn&rsquo;t take me long to find a very interesting call at <code>0x270f26</code> with these parameters:</p><ul><li><code>RCX</code>: address of some region in memory</li><li><code>RDX</code>: address of the plaintext</li><li><code>R8</code>: address to <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')&input=MDEgQjQgMkYgMEUgN0UgM0IgMzIgRTcgQzQgMjUgMUIgQzMgOEYgQTIgQUUgMkUgREIgOEQgQzIgNjQgOTggRTUgQjcgM0UgMkEgOTIgQUMgOUUgOEYgRkMgQjQgRjQ"><code>01B42F0E7E3B32E7C4251BC38FA2AE2EDB8DC26498E5B73E2A92AC9E8FFCB4F4</code></a></li><li><code>R9</code>: address to <a href="https://gchq.github.io/CyberChef/#recipe=From_Hex('Auto')&input=ODQgRUYgQzQgQjggMzYgMTEgOUMgMjAgNDEgOTMgOTggQzMgRjMgRjIgQkMgRUYgNkYgQzUgMkYgOUQgODYgQzYgRTQgRTggNzUgNkEgRUMgNUEgODIgNzkgRTQgOTI"><code>84EFC4B836119C20419398C3F3F2BCEF6FC52F9D86C6E4E8756AEC5A8279E492</code></a></li></ul><p>This was very suspicious. After opening the function in Ghidra, I was very overjoyed to find this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=c1>// before cleanup
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>uVar2</span> <span class=o>=</span> <span class=n>EVP_aes_256_cbc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>iVar1</span> <span class=o>=</span> <span class=n>FUN_345be0</span><span class=p>(</span><span class=n>local_c8</span><span class=p>,</span> <span class=n>param_2</span><span class=p>,</span> <span class=n>param_3</span><span class=p>,</span> <span class=n>param_4</span><span class=p>,</span> <span class=n>uVar2</span><span class=p>,</span> <span class=n>local_e8</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=n>iVar1</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>FUN_54e50</span><span class=p>(</span><span class=o>&amp;</span><span class=n>local_60</span><span class=p>,</span> <span class=s>&#34;AES256 CBC encryption failed&#34;</span><span class=p>,</span> <span class=mh>0x1c</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// after cleanup
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>cipherType</span> <span class=o>=</span> <span class=n>EVP_aes_256_cbc</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=n>ok</span> <span class=o>=</span> <span class=n>Encrypt</span><span class=p>(</span><span class=n>local_c8</span><span class=p>,</span> <span class=n>plaintext</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>iv</span><span class=p>,</span> <span class=n>cipherType</span><span class=p>,</span> <span class=n>encryptedOut</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ok</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Log</span><span class=p>(</span><span class=o>&amp;</span><span class=n>local_60</span><span class=p>,</span> <span class=s>&#34;AES256 CBC encryption failed&#34;</span><span class=p>,</span> <span class=mh>0x1c</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Turns out that EA Desktop is using <a href=https://linux.die.net/man/3/evp_cipher_ctx_init>OpenSSL&rsquo;s EVP functions</a> to encrypt their files. In this case the file we need is encrypted using <a href=https://www.nist.gov/publications/advanced-encryption-standard-aes>AES</a> with a key length of 256 bits using the Cipher Block Chaining (CBC) mode.</p><p>Using x64dbg, I just dumped the Key and IV from memory and used <a href="https://gchq.github.io/CyberChef/#recipe=Drop_bytes(0,64,false)AES_Decrypt(%7B'option':'Hex','string':'01B42F0E7E3B32E7C4251BC38FA2AE2EDB8DC26498E5B73E2A92AC9E8FFCB4F4'%7D,%7B'option':'Hex','string':'84EFC4B836119C20419398C3F3F2BCEF6FC52F9D86C6E4E8756AEC5A8279E492'%7D,'CBC','Raw','Raw',%7B'option':'Hex','string':''%7D,%7B'option':'Hex','string':''%7D)&input=YWxsVXNlcnNHZW5lcmljSWQ">CyberChef</a> to successfully decrypt the file:</p><figure class=align-center><img loading=lazy src=/img/posts/2023-01-18/EA_Encryption_Decrypted.png#center alt="Screenshot of CyberChef that shows the successful decryption"><figcaption><p>Successful decryption in CyberChef</p></figcaption></figure><h3 id=recreating-the-iv>Recreating the IV<a hidden class=anchor aria-hidden=true href=#recreating-the-iv>#</a></h3><p>At this point I was very happy. I managed to identify the algorithm being used and was able to decrypt the file using the Key and IV from memory. The next step was figuring out how I can recreate them. You have to remember that my goal is to implement a method in my library, that can decrypt the file on its own, without requiring the consumer of the library to do anything special.</p><p>I started by following the parameters being passed to the encryption function. These values have to come from somewhere and I intend to find out where. Once again, I&rsquo;m using x64dbg to step through the function and look closely at the registers. Now that I know what the Key and IV look like, I can identify the functions that create them or at least reference them.</p><p>And just as luck would have it, I found a function before the encryption function that accepts some curious parameters and outputs the Key and IV:</p><ul><li><code>RCX</code>: address of some region in memory</li><li><code>RDX</code>: address of the string <code>allUsersGenericId</code></li><li><code>R8</code>: address of the string <code>IS</code></li></ul><p>Once again I investigated and after a bit of cleanup, the function essentially does this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>CreateCryptographicHash</span><span class=p>(</span><span class=n>cryptographicHash</span><span class=p>,</span> <span class=mh>0x100</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>AddDataToHash</span><span class=p>(</span><span class=n>cryptographicHash</span><span class=p>,</span> <span class=n>param_2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>AddDataToHash</span><span class=p>(</span><span class=n>cryptographicHash</span><span class=p>,</span> <span class=n>param_3</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>ok</span> <span class=o>=</span> <span class=n>FinalizeHash</span><span class=p>(</span><span class=n>cryptographicHash</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>finalHashOut</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p>These are wrapper functions for <a href=https://doc.qt.io/qt-5/qcryptographichash.html><code>QCryptographicHash</code></a> from <a href=https://www.qt.io/qt-5-12>Qt 5</a>. <code>CreateCryptographicHash</code> is a wrapper for the constructor <code>QCryptographicHash(QCryptographicHash::Algorithm method)</code> where they always pass <strong>SHA3 256</strong> as the algorithm and <code>AddDataToHash</code> is a wrapper for <code>addData(const char *data, int length)</code>.</p><p>If you&rsquo;re like me, and you see this, then you quickly head over to <a href="https://gchq.github.io/CyberChef/#recipe=SHA3('256')&input=YWxsVXNlcnNHZW5lcmljSWRJUw">CyberChef</a>, input <code>allUsersGenericIdIS</code> and create the SHA3 256 hash to get <strong>THE IV</strong> as output: <code>84efc4b836119c20419398c3f3f2bcef6fc52f9d86c6e4e8756aec5a8279e492</code>.</p><p><strong>THE IV NEVER CHANGES:</strong> It&rsquo;s always <code>SHA3_256("allUsersGenericId" + "IS")</code>, a fucking <strong>constant</strong>.</p><p>As a quick side note: remember <code>530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e</code>? This is the folder name of the file <code>IS</code>. This is also a SHA3 256 hash (<a href="https://gchq.github.io/CyberChef/#recipe=SHA3('256')&input=YWxsVXNlcnNHZW5lcmljSWQ">CyberChef</a>):</p><pre tabindex=0><code>SHA3_256(&#34;allUsersGenericId&#34;) = 530c11479fe252fc5aabc24935b9776d4900eb3ba58fdc271e0d6229413ad40e
</code></pre><p>I have no idea where this <code>allUsersGenericId</code> comes from, but some genius at EA thought it would be a good idea to include this in almost every hash.</p><h3 id=recreating-the-key>Recreating the Key<a hidden class=anchor aria-hidden=true href=#recreating-the-key>#</a></h3><p>Anyways, we have the IV. Now the remaining part is figuring out how to recreate the Key, which turned out to be more involved than the IV.</p><p>The function that creates IV did some more stuff afterwards. They reset the SHA3 256 hash instance and added some very interesting data to it: <code>allUsersGenericIdISa2a0ad25aa3556c035b34ea63863794e54ad5b53</code> (<a href="https://gchq.github.io/CyberChef/#recipe=SHA3('256')&input=YWxsVXNlcnNHZW5lcmljSWRJU2EyYTBhZDI1YWEzNTU2YzAzNWIzNGVhNjM4NjM3OTRlNTRhZDViNTM">CyberChef</a>)</p><pre tabindex=0><code>SHA3_256(&#34;allUsersGenericIdISa2a0ad25aa3556c035b34ea63863794e54ad5b53&#34;) = 01b42f0e7e3b32e7c4251bc38fa2ae2edb8dc26498e5b73e2a92ac9e8ffcb4f4
</code></pre><p>This is the key we previously dumped from memory. Let&rsquo;s break this down: <code>"allUsersGenericId" + "IS" + "a2a0ad25aa3556c035b34ea63863794e54ad5b53"</code>. The first two parts are already known to us, they are the components of the IV. The last part <code>a2a0ad25aa3556c035b34ea63863794e54ad5b53</code> is more interesting. This looks like another hash, but it only has a length of 160 bits. Once again we can use <a href="https://gchq.github.io/CyberChef/#recipe=Analyse_hash()&input=YTJhMGFkMjVhYTM1NTZjMDM1YjM0ZWE2Mzg2Mzc5NGU1NGFkNWI1Mw">CyberChef</a> to analyze this hash:</p><pre tabindex=0><code>Hash length: 40
Byte length: 20
Bit length:  160

Based on the length, this hash could have been generated by one of the following hashing functions:
SHA-1
SHA-0
FSB-160
HAS-160
HAVAL-160
RIPEMD-160
Tiger-160
</code></pre><p>Based on the previous results, I&rsquo;m assuming this is a SHA1 hash, since that&rsquo;s the only one that OpenSSL supports. With this information in hand, I decided to try going the opposite way and start with the import of <a href=https://linux.die.net/man/3/evp_sha1><code>EVP_sha1</code></a> and look at what references this. Turns out there is only one function that uses this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=cl><span class=n>ulonglong</span> <span class=nf>HashSomething</span><span class=p>(</span><span class=n>undefined8</span><span class=o>*</span> <span class=n>param_1</span><span class=p>,</span> <span class=n>undefined8</span> <span class=n>param_2</span><span class=p>,</span> <span class=kt>int</span> <span class=n>param_3</span><span class=p>,</span> <span class=n>undefined8</span><span class=o>*</span> <span class=n>param_4</span><span class=p>,</span> <span class=kt>int</span> <span class=n>param_5</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span> <span class=p>(</span><span class=n>param_5</span> <span class=o>-</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=n>algorithm</span> <span class=o>=</span> <span class=n>EVP_sha1</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ctx</span> <span class=o>=</span> <span class=n>EVP_MD_CTX_new</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ok</span> <span class=o>=</span> <span class=n>EVP_DigsteInit_ex</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>algorithm</span><span class=p>,</span> <span class=k>nullptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>EVP_DigestUpdate</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=n>param_2</span><span class=p>,</span> <span class=n>param_3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>EVP_DigestFinal_ex</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=o>*</span><span class=n>param_4</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>param_5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>EVP_MD_CTX_free</span><span class=p>(</span><span class=n>ctx</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I aptly named this function <code>HashSomething</code> as it appears to be some sort of general purpose hashing function that takes some input, the output buffer and probably an enum to control which hashing algorithm should be used. This looked very promising, so I went back to x64dbg, put a breakpoint at the start of the function and inspected the input, only to find this:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>ASRock;                      ;American Megatrends Inc.;To Be Filled By O.E.M.;7CB7433E;PCI\VEN_10DE&amp;DEV_2486&amp;SUBSYS_147A10DE&amp;REV_A1\4&amp;2283F625&amp;0&amp;0019;AuthenticAMD;178BFBFF00A20F10;AMD Ryzen 7 5800X 8-Core Processor             ;
</span></span></code></pre></td></tr></table></div></div><p>Using <a href="https://gchq.github.io/CyberChef/#recipe=SHA1(80)&input=QVNSb2NrOyAgICAgICAgICAgICAgICAgICAgICA7QW1lcmljYW4gTWVnYXRyZW5kcyBJbmMuO1RvIEJlIEZpbGxlZCBCeSBPLkUuTS47N0NCNzQzM0U7UENJXFZFTl8xMERFJkRFVl8yNDg2JlNVQlNZU18xNDdBMTBERSZSRVZfQTFcNCYyMjgzRjYyNSYwJjAwMTk7QXV0aGVudGljQU1EOzE3OEJGQkZGMDBBMjBGMTA7QU1EIFJ5emVuIDcgNTgwMFggOC1Db3JlIFByb2Nlc3NvciAgICAgICAgICAgICA7">CyberChef</a> to verify my assumption, I was very happy to find out that this is the missing component:</p><pre tabindex=0><code>SHA1(hardwareInfo) = a2a0ad25aa3556c035b34ea63863794e54ad5b53
</code></pre><p>They hash the hardware info using SHA1, then combine that hash with the constants <code>allGenericId</code> and <code>IS</code> to create the Key.</p><h3 id=hardware-information>Hardware Information<a hidden class=anchor aria-hidden=true href=#hardware-information>#</a></h3><p>In order to replicate the hardware info hash, I needed to figure out which components and which properties went into it and where they are getting the information from. On Windows, the best way to do this, is to use the <a href=https://learn.microsoft.com/en-us/windows/win32/wmisdk/about-wmi>WMI</a>. I&rsquo;ve never used the WMI, so I just checked out an <a href=https://learn.microsoft.com/en-us/windows/win32/wmisdk/example--getting-wmi-data-from-the-local-computer-asynchronously>example</a> to find the library functions I need to look out for. These include <code>CoInitialize</code>, <code>CoCreateInstance</code> and <code>CoSetProxyBlanket</code>, just to name a few. With that newly found information, I went back into Ghidra and went up the call stack of the general purpose hashing function to find something that looks good.</p><p>I ended up in a function that was being called by the function that creates the IV and Key. However, I noticed that there was a big fat static initialization being done. Turns out that they collect your hardware information when the process starts and then never again. Using x64dbg to restart the process and I stepped through the static initialization to figure out what was going on.</p><p>After a rather tedious process of continuously looking at register values until something made sense, I managed to extract every class and property name used to create the hardware info:</p><ul><li><code>Win32_BaseBoard Manufacturer</code> = <code>ASRock</code></li><li><code>Win32_BaseBoard SerialNumber</code> = <code></code>(string with lots of whitespace)</li><li><code>Win32_BIOS Manufacturer</code> = <code>American Megatrends Inc.</code></li><li><code>Win32_BIOS SerialNumber</code> = <code>To Be Filled By O.E.M.</code></li><li><code>Win32_VideoController PNPDeviceId</code> = <code>PCI\VEN_10DE&DEV_2486&SUBSYS_147A10DE&REV_A1\4&2283F625&0&0019</code></li><li><code>Win32_Processor Manufacturer</code> = <code>AuthenticAMD</code></li><li><code>Win32_Processor ProcessorId</code> = <code>178BFBFF00A20F10</code></li><li><code>Win32_Processor Name</code> = <code>AMD Ryzen 7 5800X 8-Core Processor</code> (also had a lot of whitespace at the end)</li></ul><p>You can try this out yourself by using the <a href=https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmic><code>wmic</code></a> tool:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>wmic</span> <span class=n>PATH</span> <span class=n>Win32_BaseBoard</span> <span class=n>get</span> <span class=n>Manufacturer</span>
</span></span></code></pre></td></tr></table></div></div><p>But we&rsquo;re not done yet. There is one value missing: <code>7CB7433E</code>. This is the hex value of the serial number of the volume associated with the root directory of your <code>C:\</code> drive. It is returned by <a href=https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getvolumeinformationw><code>GetVolumeInformationW</code></a>. Note that this a different serial number from the one obtained by <code>Win32_PhysicalMedia SerialNumber</code>:</p><blockquote><p>This function returns the volume serial number that the operating system assigns when a hard disk is formatted. To programmatically obtain the hard disk&rsquo;s serial number that the manufacturer assigns, use the Windows Management Instrumentation (WMI) Win32_PhysicalMedia property SerialNumber.</p></blockquote><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><script src=https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js integrity="sha256-QdTG1YTLLTwD3b95jLqFxpQX9uYuJMNAtVZgwKX4oYU=" crossorigin=anonymous></script>
<script type=text/javascript>mermaid.initialize({useMaxWidth:!0,htmlLabels:!1})</script><pre class=mermaid align=center>
graph TD
    allUsersGenericId & IS --> allUsersGenericIdIS[allUsersGenericId + IS]
    hardwareInfo[Hardware Information] --> |SHA1| hardwareInfoHash[Hardware Info Hash]
    allUsersGenericIdIS & hardwareInfoHash --> combine[allUsersGenericId + IS + Hardware Info Hash] --> |SHA3 256| KEY
    allUsersGenericIdIS --> |SHA3 256| IV
</pre><p>This flowchart shows the complete process of generating the Key and IV. With those values, you can easily decrypt the file using AES 256 CBC.</p><p>Let&rsquo;s go back to the point of all of this: finding out which games are installed. I did all of this just to decrypt a file that contains some installation paths to EA games. I don&rsquo;t understand why this file is encrypted in the first place. It doesn&rsquo;t make any sense. You encrypt a file because it contains sensitive information and/or you want to keep it from prying eyes. Now the question is &ldquo;who is not supposed to read this file&rdquo;? The fact that they created the plaintext version of this file at some point but later changed it <strong>on purpose</strong> means they don&rsquo;t want <em>anyone</em> to read it.</p><p>And this isn&rsquo;t even all, if you look at the flowchart, you will realize that if the user changes a single hardware component of their PC, the Key will be different, and you won&rsquo;t be able to decrypt the file anymore. The team at EA that implemented this and the person that made the decision to encrypt the file in the first place, have no idea what they are doing. This is a pathetic attempt to prevent users from reading this file.</p><p>I have demonstrated how easy it is to &ldquo;break&rdquo; the encryption using tools like <a href=https://gchq.github.io/CyberChef/>CyberChef</a>, <a href=https://x64dbg.com/>x64dbg</a> and <a href=https://github.com/NationalSecurityAgency/ghidra>Ghidra</a>. The &ldquo;encryption&rdquo; used by EA Desktop is straight up pathetic and useless. In the off chance that anyone from the team that works on the program is reading this: just write the plaintext file, there is no point in encrypting it.</p><p>For me personally, this has been a very fun adventure. I managed to make good progress every day and got more experience using the tools listed above and assembly in general. I can also now finally have support for EA Desktop in my <a href=https://github.com/erri120/GameFinder>GameFinder</a> library, so users can stop pinging me about it.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://erri120.github.io/tags/reverse-engineering/>Reverse Engineering</a></li></ul><nav class=paginav><a class=next href=https://erri120.github.io/posts/2022-05-05/><span class=title>Next »</span><br><span>Getting started with GNU gettext for C++</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Breaking EA Desktop's pathetic Encryption on twitter" href="https://twitter.com/intent/tweet/?text=Breaking%20EA%20Desktop%27s%20pathetic%20Encryption&url=https%3a%2f%2ferri120.github.io%2fposts%2f2023-01-18%2f&hashtags=ReverseEngineering"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Breaking EA Desktop's pathetic Encryption on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ferri120.github.io%2fposts%2f2023-01-18%2f&title=Breaking%20EA%20Desktop%27s%20pathetic%20Encryption"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=erri120/erri120.github.io issue-term=pathname label=site-comment theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2023 <a href=https://erri120.github.io>erri120's random Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>