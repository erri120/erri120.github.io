<!doctype html><html lang=en>
<head>
<title>Don't count frames to calculate time :: erri120's very random Blog</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="RPG Maker MV/MZ uses the amount of rendered frames to calculate how long player has been playing the game. They sadly forgot that 60 frames do not always equal 1 second and that you can just use a timestamp instead. This is a very simple fix that you should implement in your game after reading this post!">
<meta name=keywords content="RPG Maker MV,RPG Maker MZ">
<meta name=robots content="noodp">
<link rel=canonical href=https://erri120.github.io/posts/2021-09-29/>
<link rel=stylesheet href=https://erri120.github.io/assets/style.css>
<link rel=stylesheet href=https://erri120.github.io/assets/organe.css>
<link rel=apple-touch-icon href=https://erri120.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://erri120.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:site content="erri120">
<meta name=twitter:creator content="erri120">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Don't count frames to calculate time">
<meta property="og:description" content="RPG Maker MV/MZ uses the amount of rendered frames to calculate how long player has been playing the game. They sadly forgot that 60 frames do not always equal 1 second and that you can just use a timestamp instead. This is a very simple fix that you should implement in your game after reading this post!">
<meta property="og:url" content="https://erri120.github.io/posts/2021-09-29/">
<meta property="og:site_name" content="erri120's very random Blog">
<meta property="article:published_time" content="2021-09-29 16:21:15 +0100 +0100">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","name":"Don\u0027t count frames to calculate time","description":"RPG Maker MV\/MZ uses the amount of rendered frames to calculate how long player has been playing the game. They sadly forgot that 60 frames do not always equal 1 second and that you can just use a timestamp instead. This is a very simple fix that you should implement in your game after reading this post!","author":{"@type":"Person","name":"erri120"},"datePublished":"2021-09-29","headling":"Don\u0027t count frames to calculate time","keywords":"RPG Maker MV, RPG Maker MZ"}</script>
<link href=/posts/2021-09-29/index.xml rel=alternate type=application/rss+xml title="erri120's very random Blog">
<meta name=google-site-verification content="c-L5KbBKeVyZ9YNKiotqlpl7zsiDRiGcWJa4ZxVpzAo">
<meta name=msvalidate.01 content="0E353603CBFC6B4F85D605C4E9F27290">
</head>
<body class=organe>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
erri120's Blog
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
</ul>
</nav>
</header>
<div class=content>
<main class=post>
<article>
<h1 class=post-title>
<a href=https://erri120.github.io/posts/2021-09-29/>Don&rsquo;t count frames to calculate time</a></h1>
<div class=post-meta>
<span class=post-date>
<time datetime=2021-09-29>2021-09-29</time>
</span>
<span class=post-author>:: erri120</span>
</div>
<span class=post-tags>
#<a href=https://erri120.github.io/tags/game-development/>Game Development</a>&nbsp;
#<a href=https://erri120.github.io/tags/rpg-maker/>RPG Maker</a>&nbsp;
#<a href=https://erri120.github.io/tags/javascript/>JavaScript</a>&nbsp;
</span>
<div class=post-content><div>
<h2 id=time-and-frames>Time and Frames<a href=#time-and-frames class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>We have all heard the term FPS, frames per second, which tells us how many frames are rendered on screen within one second. Higher FPS will result in smoother animations because those animations get more frames. The problem with high FPS is that the GPU has to keep up with this demand and be able to produce 30/60/144 or more frames within 1 second. This is where frame times, VSync and a bunch of offer stuff that I won&rsquo;t cover here comes into play.</p>
<p>The important takeaway is that you can not reliably calculate a duration based on how many frames where rendered because not every frame takes the same amount of time. This is a problem when you want to eg smoothly move an object from one position to another. Engines like Unity solve this by providing a delta time <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> which is the interval from the last to the current frame so you can have smooth translations.</p>
<h2 id=looking-at-rpg-maker-mvmz>Looking at RPG Maker MV/MZ<a href=#looking-at-rpg-maker-mvmz class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>So what issue does RPG Maker have? I have recently played a game for around 21 hours but the save menu displayed over 51 hours, more than double. Actually not just more than double but around 2.4 times more than expected. This quickly made me realize that I had been playing the game on my 144Hz monitor meaning instead of rendering at 60 FPS, the game was rendering at 144 FPS. I hope you notice that <code>60 x 2.4</code> equals <code>144</code>.</p>
<p>To further investigate the problem I took a peek inside the <code>js</code> folder, did a quick search for &ldquo;playtime&rdquo; and found the culprits of my frustration:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>onBeforeSave</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_framesOnSave</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>Graphics</span>.<span style=color:#a6e22e>frameCount</span>;
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>onAfterLoad</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
    <span style=color:#a6e22e>Graphics</span>.<span style=color:#a6e22e>frameCount</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_framesOnSave</span>;
    <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>playtime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>Graphics</span>.<span style=color:#a6e22e>frameCount</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>);
};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>playtimeText</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>hour</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>playtime</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>);
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>min</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>playtime</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>) <span style=color:#f92672>%</span> <span style=color:#ae81ff>60</span>;
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sec</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>playtime</span>() <span style=color:#f92672>%</span> <span style=color:#ae81ff>60</span>;
    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hour</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>min</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>sec</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>);
};
</code></pre></div><p>A quick explanation: whenever you save, the game includes the amount of frames it has rendered in the save file because <code>Game_System</code> is serialized in the save file and <code>_framesOnSave</code> is a field of that object. Of course when you load the save will get deserialized and <code>Graphics.frameCount</code> will be set back to that value. In case you are wondering: <code>Graphics.frameCount</code> gets incremented on each render.</p>
<p>This is fine so far but the real problems are found in the <code>playtime</code> and <code>playtimeText</code> functions where the game assumes you constantly playing at 60 frames per second. The pure <code>frameCount</code> gets divided by <code>60</code> to get the amount of seconds passed and in <code>playtimeText</code> that result is further processed to the get hours and minutes.</p>
<p>Due to the multiple issues outlined at the beginning you can see that this is not a good idea. Having said that: let&rsquo;s look at how to fix this.</p>
<h2 id=possible-solution>Possible Solution<a href=#possible-solution class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>This solution is probably the easiest and most straightforward one I can think of:</p>
<ul>
<li>on load/start: set <code>startTime</code> to the current time</li>
<li>on save:
<ol>
<li>get the current time and calculate the difference between now and <code>startTime</code></li>
<li>add the difference to a variable in the save</li>
</ol>
</li>
</ul>
<p>No need for frame count calculations or anything complex, just use <code>Date.now()</code> a few times and get the difference.</p>
<h3 id=changing-the-implementation-in-rpg-maker-mv>Changing the implementation in RPG Maker MV<a href=#changing-the-implementation-in-rpg-maker-mv class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>Start by opening <code>js/rpg_objects.js</code> and look for the <code>initialize</code> function. Here we want to add two new fields:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>initialize</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_playtime</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p><code>Date.now()</code> returns the current <a href=https://currentmillis.com/>Unix time</a> as an integer that looks like this: <code>1632928643900</code>.</p>
<p>We need to set the start time in the <code>initialize</code> function for when the game starts and in the <code>onAfterLoad</code> function for when the player loads a save file:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>onAfterLoad</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>The <code>onBeforeSave</code> function gets called before the save is serialized so here we have to calculate the time difference and reset the start time:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>onBeforeSave</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_playtime</span> <span style=color:#f92672>+=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_startTime</span>;
  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
  <span style=color:#75715e>// ...
</span><span style=color:#75715e></span>}
</code></pre></div><p>Assuming the player started at <code>1632928643900</code> and played for 1 second till <code>1632928644900</code>, <code>this._playtime</code> will now be <code>1000</code>. The only thing remaining is updating the <code>playtime</code> function:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>playtime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
  <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>_playtime</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>);
};
</code></pre></div><p>Since this function returns the amount of time passed in seconds we have to divide by 1000 to convert from milliseconds to seconds. While we are at it, I also recommend updating <code>playtimeText</code>:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>Game_System</span>.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>playtimeText</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>function</span>() {
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>secondsPassed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>playtime</span>();
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>minutesPassed</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>secondsPassed</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>);
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>hoursPassed</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>minutesPassed</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>);

  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sec</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>secondsPassed</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>60</span>;
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>min</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>minutesPassed</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>60</span>;
  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>hour</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hoursPassed</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>24</span>;

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hour</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>min</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;:&#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>sec</span>.<span style=color:#a6e22e>padZero</span>(<span style=color:#ae81ff>2</span>);
};
</code></pre></div><p>The main difference here is that we cache the result from the <code>playtime</code> function and other operations.</p>
<h2 id=afterword>Afterword<a href=#afterword class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>This issue has been bugging me a lot during my playthroughs of longer games because you don&rsquo;t really notice it when your playtime goes from 1h to 2 hours but going from 21 hours to 50+ hours was a bit more in my face. RPG Maker MZ also doesn&rsquo;t fix this and I have not seen any discussion about this.</p>
<section class=footnotes role=doc-endnotes>
<hr>
<ol>
<li id=fn:1 role=doc-endnote>
<p>See <code>Time.deltaTime</code> in the docs <a href=https://docs.unity3d.com/ScriptReference/Time-deltaTime.html>here</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p>
</li>
</ol>
</section>
</div></div>
</article>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h></span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://erri120.github.io/posts/2021-11-18/>
<span class=button__icon>←</span>
<span class=button__text>Reworking rpgmpacker: Moving from C++ to TypeScript</span>
</a>
</span>
<span class="button next">
<a href=https://erri120.github.io/posts/2021-02-04/>
<span class=button__text>CI/CD for RPG Maker Game Development</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
<hr>
<div style=margin-top:16px;margin-bottom:8px;display:flex;justify-content:center>
<script type=text/javascript src=https://storage.ko-fi.com/cdn/widget/Widget_2.js></script><script type=text/javascript>kofiwidget2.init('Support Me on Ko-fi','#29abe0','P5P03UIPI'),kofiwidget2.draw()</script>
</div>
<script src=https://utteranc.es/client.js repo=erri120/erri120.github.io issue-term=pathname label=site-comment theme=github-dark-orange crossorigin=anonymous async></script>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>CC BY 4.0</span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a> and modified by me</span>
</div>
</div>
</footer>
<script src=https://erri120.github.io/assets/main.js></script>
<script src=https://erri120.github.io/assets/prism.js></script>
</div>
</body>
</html>